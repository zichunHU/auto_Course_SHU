# SHU 选课助手 (auto_Course)

一个为上海大学教务系统设计的自动化选课工具。它通过模拟用户操作，提供从登录、课程搜索、目标管理到自动抢课的全流程支持，旨在帮助学生更高效地完成选课任务。

## ✨ 功能特性

- **统一认证登录 (SSO)**
  - 适配上海大学的统一身份认证系统。
  - 用户密码在本地通过 **RSA 公钥加密** 后再传输，确保凭据在传输过程中的安全。

- **选课参数自动提取**
  - 程序启动后，自动访问选课页面，智能提取 `xkxnm` (选课学年)、`xkxqm` (选课学期) 等核心参数。
  - 这些参数是后续所有选课操作的基础，自动提取避免了手动查找和配置的麻烦。

- **强大的课程搜索与管理**
  - **关键词搜索**：支持按课程名称、教师姓名等关键词模糊搜索。
  - **分页展示**：搜索结果以清晰的表格形式分页展示，方便查阅。
  - **交互式添加**：在搜索结果中，可通过交互式菜单选择一门或多门课程，将其加入“抢课列表”。
  - **导出功能**：可将搜索到的课程列表导出为 `JSON` 文件，便于离线分析。

- **灵活的自动抢课策略**
  - **多目标支持**：可同时将多门课程加入抢课列表。
  - **可配置时间间隔**：自定义每次抢课请求之间的最小和最大延迟（秒），模拟人类操作，避免对服务器造成过大压力。
  - **最大尝试次数**：可为每门课程设置最大抢课尝试次数，达到次数后自动放弃，或设置为 `0` 进行无限次尝试。
  - **随机化顺序**：支持对抢课列表中的课程进行随机排序，避免每次都从固定顺序开始，提高成功率。
  - **失败自动退避**：当一次选课请求失败时，程序会自动暂停一段时间，避免因连续无效请求被系统限制。
  - **状态持久化**：抢课目标和状态会保存在本地 `data/target_courses.json` 文件中，即使程序重启，也能恢复之前的列表。

- **课表与考试信息获取**
  - **已选课表查询**：一键获取当前学期已成功选上的课程列表，并以易于阅读的格式展示。
  - **考试安排查询**：一键获取已选课程的考试时间与地点安排。
  - **导出课表/考试**：支持将课表和考试信息导出为 `JSON` 文件，方便导入到日历或其他应用。

- **本地课程状态分析**
  - 运行 `course_checker.py` 脚本，可对本地保存的 `JSON` 文件进行分析。
  - 统计已确认、等待中、未选上等状态的课程数量。
  - 分析课程是否存在扩容（总容量增加），为调整选课策略提供数据支持。

## 📂 目录结构

```
auto_Course/
├─ main.py                 # 🚀 交互式抢课助手主入口
├─ test.py                 # 🔬 课程搜索与即时选课演示（使用 orchestrator）
├─ course_checker.py       # 📊 本地课程状态分析工具
├─ requirements.txt        # 📦 Python 依赖列表
├─ README.md               # 📄 项目说明文档
├─ tests/                  # 🧪 服务一致性测试脚本
│  └─ test_services.py
├─ modules/                # 🧩 核心功能模块
│  ├─ login.py             # 登录认证
│  ├─ course_searcher.py   # 课程搜索
│  ├─ course_selector.py   # 选课执行
│  ├─ schedule_extractor.py# 课表提取
│  ├─ exam_extractor.py    # 考试信息提取
│  ├─ session_provider.py  # 会话创建与菜单初始化
│  └─ tools/               # 🛠️ 辅助工具
│     ├─ course_params_extractor.py # 选课参数提取
│     ├─ encrypt.py                 # 密码 RSA 加密
│     ├─ display.py                 # 终端表格展示与交互
│     └─ debug_utils.py             # 日志与调试
│  └─ services/            # 🛎️ 业务服务层 (封装)
│     ├─ login_service.py
│     ├─ param_service.py
│     ├─ search_service.py
│     ├─ select_service.py
│     ├─ schedule_service.py
│     └─ exam_service.py
├─ functions/              # 🏗️ 应用逻辑与编排
│  ├─ app_orchestrator.py  # 应用主编排器 (CLI菜单逻辑)
│  ├─ course_sniper.py     # 抢课循环控制器
│  ├─ course_storage.py    # 课程数据持久化
│  ├─ result.py            # 统一返回结构封装
│  └─ types.py             # 类型定义 (TypedDict)
├─ utils/                  # ⚙️ 通用工具
│  └─ common.py            # 通用函数 (如中断、倒计时)
└─ data/
   └─ target_courses.json  # 存储抢课目标的 JSON 文件
```

## 🚀 快速开始

### 1. 环境准备

- **Python 版本**: 建议 `Python 3.9` 或更高版本。
- **克隆项目**:
  ```bash
  git clone <repository_url>
  cd auto_Course
  ```
- **创建并激活虚拟环境**:
  - macOS / Linux:
    ```bash
    python3 -m venv .venv
    source .venv/bin/activate
    ```
  - Windows:
    ```bash
    python -m venv .venv
    .venv\Scripts\activate
    ```
- **安装依赖**:
  ```bash
  pip install -r requirements.txt
  ```
- **安装可选依赖 (为了更好的表格展示效果)**:
  ```bash
  pip install tabulate prettytable
  ```

### 2. 配置凭据

**重要**: 出于安全考虑，请**不要**直接在代码中运行硬编码的学号和密码。

打开 `main.py` 文件，找到以下几行，并修改为**你自己的学号和密码**:

```python
# main.py
sid = "你的学号"
pwd = "你的密码"
year = 2025 # 目标学年
term = 2    # 目标学期 (1: 秋季, 2: 春季)
```

### 3. 运行主程序

配置完成后，运行交互式抢课助手：

```bash
python main.py
```

程序启动后，会显示主菜单，您可以根据提示进行操作：

1.  **登录并提取参数**: 程序会自动完成。
2.  **搜索课程**: 选择 `1. 搜索课程并添加到抢课列表`，输入关键词。
3.  **添加目标**: 在搜索结果中，按提示将心仪的课程加入抢课列表。
4.  **配置抢课**: 选择 `3. 开始抢课`，设置抢课的时间间隔、尝试次数等。
5.  **开始抢课**: 配置完成后，程序将自动开始循环抢课。您可以随时按 `Ctrl+C` 中止。
6.  **查看结果**: 抢课结束后或在抢课过程中，可以随时查看当前课表，确认是否成功。

## 🛠️ 其他功能

- **即时选课演示 (`test.py`)**
  - 此脚本用于快速测试课程搜索和单次选课功能。
  - 修改 `test.py` 中的凭据后运行：`python test.py`

- **本地课程状态分析 (`course_checker.py`)**
  - 分析 `data/target_courses.json` 文件，统计课程状态。
  - 首先确保该文件存在且包含课程数据，然后运行：`python course_checker.py`

- **服务一致性测试 (`tests/test_services.py`)**
  - 用于验证核心服务（如登录、搜索）是否能正常工作。
  - `python tests/test_services.py`
  - **注意**: 测试中的选课功能使用了伪造的课程ID，**不会**对您的真实课表产生影响。

## 🏛️ 架构与设计

本项目采用分层架构，确保代码的模块化和可维护性：

- **应用层 (`functions/app_orchestrator.py`)**:
  - 作为用户界面的直接驱动者，负责解析用户输入，调用下层服务，并组织业务流程。它是整个交互式体验的核心。
- **服务层 (`modules/services/*.py`)**:
  - 对核心功能模块的薄封装，为应用层提供统一、简洁的接口。例如，`LoginService` 组合了加密和请求，向上只提供一个 `login` 方法。它负责注入 `session` 会话对象，并统一返回结果格式。
- **核心模块层 (`modules/*.py`)**:
  - 实现了各项具体功能，如 `login.py` 处理登录请求，`course_searcher.py` 负责课程搜索。这些模块是无状态的，依赖上层传入的参数和会话。
- **工具层 (`modules/tools/*.py`, `utils/`)**:
  - 提供各种辅助功能，如 `encrypt.py` 的密码加密、`display.py` 的终端UI渲染、`debug_utils.py` 的日志配置等。
- **数据持久化层 (`functions/course_storage.py`)**:
  - 负责将用户的抢课列表读取或写入到本地 `JSON` 文件，实现了状态的持久化。

## ⚠️ 安全与注意事项

- **凭据安全**:
  - **强烈建议** 使用环境变量或 `.env` 文件来管理您的学号和密码，而不是硬编码在 `main.py` 中。这是为了防止意外将您的个人凭据提交到代码仓库或分享给他人。
- **RSA 公钥**:
  - 登录时使用的 RSA 公钥 (`PUB_KEY_PEM`) 硬编码在 `modules/tools/encrypt.py` 中。如果学校教务系统更新了加密方式，此公钥可能会失效，届时需要手动从登录页面获取新的公钥并替换。
- **接口与参数**:
  - 教务系统的接口和参数（如 `xkkz_id`）可能会在未来更新。虽然本工具已尽可能动态提取参数，但某些部分仍可能失效。如果遇到问题，请检查相关模块是否与当前教务系统匹配。
- **合理的抢课频率**:
  - 请设置一个合理的抢课时间间隔（例如，`1-3` 秒或更长）。过于频繁的请求会给学校服务器带来不必要的压力，并可能导致您的账户被临时封禁。

## ❓ FAQ

- **登录失败或提示“会话初始化失败”？**
  - 检查您的学号和密码是否正确。
  - 可能是学校更新了 RSA 公钥，请参考上一节的说明进行替换。
  - 检查您的网络连接是否正常，能否访问教务系统。
- **搜索不到任何课程？**
  - 确认当前是否处于选课时间段内。
  - 检查 `main.py` 中配置的 `year` 和 `term` 是否正确。
  - 尝试使用更宽泛的关键词进行搜索。
- **运行后表格显示不正常或报错？**
  - 请确保已安装可选依赖 `tabulate` 和 `prettytable`。

## 🔧 开发与维护建议

- **凭据管理**: 引入 `python-dotenv` 库，从 `.env` 文件中加载凭据。
- **依赖管理**: 将可选依赖 `tabulate`, `prettytable` 添加到 `requirements.txt` 中。
- **参数动态化**: 将 `xkkz_id` 等可能变化的参数改为从页面动态提取，减少硬编码。
- **测试覆盖**: 增加单元测试和集成测试，特别是针对登录、参数提取和选课提交流程。
- **配置灵活性**: 通过命令行参数（如 `argparse`）或配置文件来传递学年、学期等参数，支持非交互式运行。

## ⚖️ 免责声明

本项目仅供个人学习和技术交流使用。请严格遵守上海大学教务系统的相关规定。任何因不当使用本项目（如设置过短的请求间隔、用于商业目的等）而导致的任何后果，由使用者本人承担。