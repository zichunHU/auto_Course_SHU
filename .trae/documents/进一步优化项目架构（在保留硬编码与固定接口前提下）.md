## 目标与原则
- 保留现有硬编码与固定接口行为（登录、公钥、固定 URL、`xkkz_id`、`code/msg/data` 返回结构）。
- 优化分层与职责、减少重复、统一结果与错误处理、提升可维护性；不改变用户交互与外部接口。

## 分层与目录
- Application（用例编排）
  - `functions/app_orchestrator.py` 已提供菜单交互；继续收敛 `test.py` 的演示用例。
- Services（业务服务薄封装）
  - 在 `functions/` 下新增轻量服务封装，包装 `modules/*`：`LoginService`、`ParamService`、`SearchService`、`SelectService`、`ScheduleService`。
- Infrastructure（工具与适配器）
  - `modules/session_provider.py` 已创建统一会话与菜单初始化；逐步集成到服务层。
- Domain（轻量模型与类型）
  - 仅添加类型约束（TypedDict/dataclass），不改变字段名与外部字典结构。

## 具体改造点
1. 统一结果返回
   - 新增 `functions/result.py`：提供 `ok(data, msg="")` 与 `err(code, msg, data=None)`，统一 `{code,msg,data}`。
   - 服务层统一包装返回；调用方不变。
2. 类型约束与可读性
   - 新增 `functions/types.py`：`Course`、`CourseParams`、`ScheduleItem`、`Result[T]`（TypedDict/dataclass）。
   - 仅用于内部标注与静态检查，外部仍传/收 `dict`。
3. 服务薄封装
   - 在 `functions/` 下新增：
     - `LoginService`：复用 `modules/login.py`，可选接入 `SessionProvider`；行为不变。
     - `ParamService`：复用 `CourseParamsExtractor`；统一缺参告警与默认值。
     - `SearchService`：复用 `CourseSearcher`；统一空结果逻辑与日志摘要。
     - `SelectService`：复用 `CourseSelector`；保留硬编码 `xkkz_id`；统一成功/失败语义。
     - `ScheduleService`：复用 `ScheduleExtractor`；统一未登录/过期处理。
4. 集成 `SessionProvider`
   - 在 `LoginService` 登录成功后调用一次 `init_menu(sess)`；保持与 `modules/login.py:60-69` 现有行为一致。
   - 其他服务通过构造注入 `session`（现已支持）。
5. 交互用例收敛
   - 将 `test.py` 的“搜索→展示→选择→选课”封装为 `AppOrchestrator.run_demo_select_once()`，`test.py` 调用该方法，减少重复。
   - 保持原交互提示与输出内容不变。
6. 日志与错误处理一致性
   - 在服务层使用统一的 logger（沿用 `init_logger` 设置）；补充关键请求的 URL/Payload/Headers 摘要日志，不改变级别与格式。
7. 抢课循环微调（不变更行为）
   - 在 `CourseSniper` 内引入简易“状态汇报”帮助函数，统一成功/失败/退避日志文案；保留现有参数与逻辑。
8. 配置集中但保留硬编码
   - 新增 `functions/config.py`（可选）：集中默认硬编码（学号、密码、URL、学年学期），`main.py`/`test.py` 读取默认值；仍维持相同常量与默认行为。

## 变更清单（最小必要新增）
- 新增文件（轻量）：`functions/result.py`、`functions/types.py`、`functions/services/*.py`（5 个）、可选 `functions/config.py`。
- 修改文件：`test.py` 引用 orchestrator 方法；服务层调用统一结果包装；必要处对 logger 引用统一。
- 保持文件名与入口：`main.py:243`、`test.py:118`、`course_checker.py:397` 不改入口语义。

## 风险与控制
- 风险：服务封装引入的返回包装偏差。
- 控制：服务层仅在原返回基础上做浅包装；新增单元测试覆盖典型路径（成功/空结果/格式错误/会话过期）。
- 回滚：保留原 `modules/*` 直接使用路径；如发现问题，调用方可直接回退为原模块调用。

## 验证方案
- 端到端：登录→参数→搜索→选择→选课→抢课→课表→状态分析全链路跑通；观察日志与持久化文件是否按预期更新。
- 回归：对比优化前后交互提示与输出一致性（尤其 `code/msg` 文案）。

## 迭代顺序
1) 引入 `result.py` 与 `types.py`；2) 实现服务薄封装并接入 orchestrator；3) 收敛 `test.py`；4) 集成 `SessionProvider` 到 `LoginService`；5) 微调 `CourseSniper` 日志；6)（可选）集中硬编码到 `config.py`。

若你确认以上方案，我将按上述顺序实施并逐步验证，确保外部行为完全一致。